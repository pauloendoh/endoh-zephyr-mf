"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withZephyr = withZephyr;
const zephyr_agent_1 = require("zephyr-agent");
const zephyr_xpack_internal_1 = require("zephyr-xpack-internal");
const ze_rspack_plugin_1 = require("./ze-rspack-plugin");
function withZephyr(zephyrPluginOptions) {
    return (config) => _zephyr_configuration(config, zephyrPluginOptions);
}
async function _zephyr_configuration(config, _zephyrOptions) {
    try {
        // create instance of ZephyrEngine to track the application
        const zephyr_engine = await zephyr_agent_1.ZephyrEngine.create({
            builder: 'rspack',
            context: config.context,
        });
        // Resolve dependencies and update the config
        const dependencyPairs = (0, zephyr_xpack_internal_1.extractFederatedDependencyPairs)(config);
        const resolved_dependency_pairs = await zephyr_engine.resolve_remote_dependencies(dependencyPairs);
        (0, zephyr_xpack_internal_1.mutWebpackFederatedRemotesConfig)(zephyr_engine, config, resolved_dependency_pairs);
        // inject the ZephyrRspackPlugin
        config.plugins?.push(new ze_rspack_plugin_1.ZeRspackPlugin({
            zephyr_engine,
            mfConfig: (0, zephyr_xpack_internal_1.makeCopyOfModuleFederationOptions)(config),
            wait_for_index_html: _zephyrOptions?.wait_for_index_html,
        }));
    }
    catch (error) {
        (0, zephyr_agent_1.logFn)('error', zephyr_agent_1.ZephyrError.format(error));
    }
    return config;
}
//# sourceMappingURL=with-zephyr.js.map